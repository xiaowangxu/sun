<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>SHU 计算机图形学</title>
</head>

<body>
	<div id="container">

	</div>
</body>

<style>
	body {
		margin: 0px;
		height: 100%;
		width: 100%;
	}

	#container {
		width: 100%;
		height: 100%;
		/* padding: auto; */
		background-color: rgb(255, 255, 255);
		display: flex;
		flex-direction: column;
		justify-content: center;
		align-items: center;
	}

	#container>canvas {
		/* width: 500px; */
		height: 100%;
		/* width: 100%; */
		/* height: 500px; */
	}
</style>

<script type="module">
	import * as SUN from '../ComputerGraphic2020/GBsun.js'

	let gameconsole = new SUN.sunConsole(512, 300, true)
	document.getElementById('container').appendChild(gameconsole.get_ConsoleDOM())
	let uid = BigInt(0)
	const Color = {
		0: SUN.Color.PICO(0),
		1: SUN.Color.PICO(1),
		2: SUN.Color.PICO(2),
		3: SUN.Color.PICO(3),
		4: SUN.Color.PICO(4),
		5: SUN.Color.PICO(5),
		6: SUN.Color.PICO(6),
		7: SUN.Color.PICO(7),
		8: SUN.Color.PICO(8),
		9: SUN.Color.PICO(9),
		10: SUN.Color.PICO(10),
		11: SUN.Color.PICO(11),
		12: SUN.Color.PICO(12),
		13: SUN.Color.PICO(13),
		14: SUN.Color.PICO(14),
		15: SUN.Color.PICO(15)
	}

	let NodeList = []

	class Node {
		constructor(
			activefunc = (val) => {
				return Math.min(0, val)
			},
			get_FuncStr = (x) => {
				return [["tanh", { color: Color[8] }], ["("], ...x, [")"]]
			}
		) {
			this.activefunc = activefunc
			this.get_FuncStr = get_FuncStr
			this.inputlist = new Set()
			this.outputlist = new Set()
			this.i = uid++
			this.value = 1
			this.rendered = false
			NodeList.push(this)
		}

		connect(node) {
			node.inputlist.add(this)
			this.outputlist.add(node)
		}

		log_Func() {
			let str = []
			this.inputlist.forEach((node) => {
				str.push(...node.log_Func())
				str.push(["*"])
				str.push(["W" + this.i, { color: Color[10] }])
				str.push(["+"])
			})
			if (str.length === 0) return [[], ['X' + this.i, { color: Color[11] }]]
			str.push(["b" + this.i, { color: Color[12] }])
			return this.get_FuncStr(str)
		}

		forward() {
			let ans = 0
			this.inputlist.forEach((node) => {
				str.push(...node.log_Func())
				str.push(["*"])
				str.push(["W" + this.i, { color: Color[10] }])
				str.push(["+"])
			})
		}

		render(render, layer = 0, y = 0) {
			if (this.rendered) return
			render.draw_Circle(layer * 50 + 50, y * 30 + 50, 10, Color[15])
			render.draw_String(layer * 50 + 50, y * 30 + 50, "X" + this.i)
			let i = 0
			this.inputlist.forEach((node) => {
				node.render(render, layer + 1, y + i)
				render.draw_Line_DDA(layer * 50 + 50, y * 30 + 50, (layer + 1) * 50 + 50, (y + i) * 30 + 50, Color[15])
				i++
			})
			this.rendered = true
		}

	}

	let a1 = new Node()
	let a2 = new Node()
	let a3 = new Node()
	let a4 = new Node()
	let a5 = new Node()
	let b = new Node()
	let c = new Node((val) => {
		return Math.min(0, val)
	},
		(x) => {
			return [["tanh", { color: Color[8] }], ["("], ...x, [")"]]
		})

	a1.connect(a2)
	a2.connect(b)
	a3.connect(b)
	a4.connect(c)
	a1.connect(a4)
	a2.connect(a4)
	a5.connect(c)
	b.connect(c)
	console.log(c.log_Func())


	gameconsole.init = (sc) => {

	}

	gameconsole.action = (sc, delta) => {

	}

	gameconsole.render = (sc, delta) => {
		// console.log(sc)
		sc.Renderer.draw_Richtext(10, 10, c.log_Func(), 3)

		NodeList.forEach((node) => { node.rendered = false })
		c.render(sc.Renderer, 0, 0)
	}

	gameconsole.run()
</script>

</html>